<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>G2MongoDB</title>

    <!-- Bootstrap -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <!-- Cover Theme -->
    <link href="../css/cover.css" rel="stylesheet">
</head>
    <body>
        <div class="site-wrapper">
            <div class="site-wrapper-inner">
                <div class="cover-container">
                    <div class="inner cover">
                        <h1>Request OAuth2 Token</h1>
                        <h1 class="cover-heading">
                            <div class="row">
                                <div class="col-sm-4 col-md-4"></div>
                                <div class="col-sm-4 col-md-4">
                                    <img src="../images/oauth-2-sm.png" alt="OAuth2.0" />
                                </div>
                                <div class="col-sm-4 col-md-4"></div>
                            </div>
                        </h1>

                        <p class="lead">
                            {% if oauth.token %}
                                <div class="row lead">
                                    <div class="col-sm-4 col-md-4"></div>
                                    <div class="col-sm-4 col-md-4">
                                        <a id="populateMongoDB" href="#" class="btn btn-lg btn-default lead">Populate MongoDB</a>
                                    </div>
                                    <div class="col-sm-4 col-md-4" style="width:3em; top:5px;">
                                        <img id="imgLoader" src="../images/ajax-loader.gif" alt="loader" style="display:none;"/>
                                    </div>
                                </div>
                                <div id="result" class="lead">
                                    <pre id="ok" style="display:none;"></pre>
                                    <pre id="ko" style="display:none;"></pre>
                                </div>
                            {% elseif oauth.error %}
                                <p class="lead">There was a problem with the OAuth2 protocol</p>
                                <p class="lead"><span class="label label-warning">Status Code: {{oauth.error.statusCode}}</span> {{oauth.error.message}}</p>
                            {% else %}
                                <p class="lead">Here you can request for an Authorization Token to export your Google SpreadSheet to MongoDB</p>
                                <div class="input-group lead">
                                    <span class="input-group-addon">Redirect Uri</span>
                                    <input id="redirectUri" type="text" class="form-control" placeholder="RedirectUri" required="" autofocus="" value="{{redirectUri}}">
                                </div>
                                <br>
                                <a id="requestButton" href="#" class="btn btn-lg btn-default lead">Request Token</a>
                            {% endif %}
                        </p>
                    </div>

                    <div class="mastfoot">
                        <div class="inner">
                        </div>
                    </div>

                </div>

            </div>
        </div>
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="../js/jquery-1.11.1.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="../js/bootstrap.min.js"></script>
        <script type="text/javascript">
            jQuery(document).ready(function(){
                jQuery('#requestButton').click(function(evt){
                    evt.preventDefault();

                    var scope = 'scope=https://www.googleapis.com/auth/drive.readonly';
                    var responseType = '&response_type=code';
                    var clientId = '&client_id={{clientId}}';
                    var redirectUri = '&redirect_uri='+jQuery('#redirectUri').val();
                    window.location.href = 'https://accounts.google.com/o/oauth2/auth?'+scope+responseType+clientId+redirectUri;
                });

                jQuery('#populateMongoDB').click(function(evt) {
                    evt.preventDefault();

                    var $a = $(this);

                    jQuery.ajax(
                            {
                                url : '/mongodb',
                                type : 'POST',
                                contentType : 'application/json',
                                dataType : 'json',
                                processData : false,
                                beforeSend : function(){
                                    jQuery("#imgLoader").show();
                                    $a.attr("disabled", true);
                                }
                            }
                    )
                          .done(function (data){
                                console.log(data);
                                jQuery("pre#ok").show();
                                jQuery("pre#ko").hide();
                                jQuery("pre#ok").css('text-align','left').html(JSON.stringify(data, undefined, 2));
                          })
                          .fail(function( jqXHR, textStatus, errorThrown ) {
                                jQuery("pre#ok").hide();
                                jQuery("pre#ko").show();
                                jQuery("pre#ko").css({'text-align':'center', 'color':'red'}).html(jqXHR.responseJSON.error);
                          })
                          .always(function(){
                                jQuery("#imgLoader").hide();
                                $a.removeAttr("disabled");
                          })
                    ;

                });
            });
        </script>
    </body>
</html>